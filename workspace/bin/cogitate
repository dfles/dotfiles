#!/usr/bin/env bash
#
# cogitate — Summon the Machine Spirit for a Linear issue.
#
# Fetches a Linear issue, consecrates a git worktree, channels the Omnissiah's
# wisdom into a Rite of Implementation, then yields control to Claude.
#
# Usage: cogitate <ISSUE-ID>   (e.g. cogitate ENG-999999)
#
# Required environment:
#   LINEAR_API_KEY   — Linear personal API key
#   COGITATE_REPO    — Absolute path to the target repo

set -euo pipefail

# ── Colours ────────────────────────────────────────────────────────────────────
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# ── Output helpers ──────────────────────────────────────────────────────────────
rite()    { echo -e "${CYAN}${BOLD}  ⚙  RITE ${1}${NC}"; }
litany()  { echo -e "${DIM}     › ${1}${NC}"; }
blessed() { echo -e "${GREEN}  ✦  ${1}${NC}"; }
heresy()  { echo -e "${RED}${BOLD}  ✗  HERESY DETECTED: ${1}${NC}" >&2; exit 1; }
warning() { echo -e "${YELLOW}  ~  ${1}${NC}"; }

# ── Banner ──────────────────────────────────────────────────────────────────────
echo ""
echo -e "${BOLD}${GREEN}  ╔══════════════════════════════════════════════════════════╗${NC}"
echo -e "${BOLD}${GREEN}  ║         C O G I T A T O R   A R R A Y   O N L I N E      ║${NC}"
echo -e "${BOLD}${GREEN}  ║              In Omnissiam Mechanicus Fidelis             ║${NC}"
echo -e "${BOLD}${GREEN}  ╚══════════════════════════════════════════════════════════╝${NC}"
echo ""

# ── Validate ───────────────────────────────────────────────────────────────────
NO_CLAUDE=false
ISSUE_ID=""
for arg in "$@"; do
    case "$arg" in
        --no-claude) NO_CLAUDE=true ;;
        *)     ISSUE_ID="$arg" ;;
    esac
done

[[ -z "$ISSUE_ID" ]] && heresy "No issue identifier provided.\n     Usage: cogitate [--no-claude] <ISSUE-ID>"

for cmd in curl jq git claude; do
    command -v "$cmd" &>/dev/null || heresy "Required instrument '${cmd}' absent from the machine spirit matrix."
done

LINEAR_API_KEY="${LINEAR_API_KEY:-}"
[[ -z "$LINEAR_API_KEY" ]] && heresy "LINEAR_API_KEY not set. Export your Linear API key before invoking this rite."

REPO="${COGITATE_REPO:-}"
[[ -z "$REPO" ]] && heresy "COGITATE_REPO not set. Export the absolute path to your target repo."
[[ -d "$REPO/.git" ]] || heresy "Reliquary not found at ${REPO}. Verify COGITATE_REPO is correct."

WORKTREES_DIR="${REPO}/.worktrees"

# ── Rite I: Communion with Linear ──────────────────────────────────────────────
rite "I — Communion with the Linear Machine Spirit"
litany "Transmitting binharic query for ${ISSUE_ID}..."

QUERY='query IssueById($id: String!) {
  issue(id: $id) {
    identifier
    title
    description
    branchName
    parent {
      identifier
      title
      description
    }
    project {
      name
      description
    }
  }
}'

RESPONSE=$(curl -s -X POST \
    -H "Authorization: ${LINEAR_API_KEY}" \
    -H "Content-Type: application/json" \
    --data "$(jq -n --arg q "$QUERY" --arg id "$ISSUE_ID" '{query: $q, variables: {id: $id}}')" \
    "https://api.linear.app/graphql")

if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
    heresy "Linear rejected the query: $(echo "$RESPONSE" | jq -r '.errors[0].message')"
fi

ISSUE_TITLE=$(echo "$RESPONSE" | jq -r '.data.issue.title // empty')
[[ -z "$ISSUE_TITLE" ]] && heresy "Issue ${ISSUE_ID} not found in the Linear archives."

ISSUE_DESC=$(echo    "$RESPONSE" | jq -r '.data.issue.description // "No description provided."')
BRANCH_NAME=$(echo   "$RESPONSE" | jq -r '.data.issue.branchName // empty')
PARENT_TITLE=$(echo  "$RESPONSE" | jq -r '.data.issue.parent.title // empty')
PARENT_DESC=$(echo   "$RESPONSE" | jq -r '.data.issue.parent.description // empty')
PROJECT_NAME=$(echo  "$RESPONSE" | jq -r '.data.issue.project.name // empty')
PROJECT_DESC=$(echo  "$RESPONSE" | jq -r '.data.issue.project.description // empty')

if [[ -z "$BRANCH_NAME" ]]; then
    SLUG=$(echo "$ISSUE_TITLE" \
        | tr '[:upper:]' '[:lower:]' \
        | sed 's/[^a-z0-9]/-/g' \
        | sed 's/--*/-/g' \
        | sed 's/^-\|-$//g' \
        | cut -c1-50)
    BRANCH_NAME="$(echo "$ISSUE_ID" | tr '[:upper:]' '[:lower:]')-${SLUG}"
fi

blessed "${ISSUE_ID}: ${ISSUE_TITLE}"
[[ -n "$PROJECT_NAME" ]] && litany "Project: ${PROJECT_NAME}"
[[ -n "$PARENT_TITLE" ]] && litany "Parent:  ${PARENT_TITLE}"

# ── Rite II: Consecration of the Code Reliquary ────────────────────────────────
rite "II — Consecration of the Code Reliquary"
litany "Worktree branch: ${BRANCH_NAME}"

mkdir -p "$WORKTREES_DIR"
WORKTREE_PATH="${WORKTREES_DIR}/${BRANCH_NAME}"

if [[ -d "$WORKTREE_PATH" ]]; then
    warning "Reliquary already exists — the Machine Spirit preserves prior work."
else
    cd "$REPO"
    git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" >/dev/null 2>&1 \
        || git worktree add "$WORKTREE_PATH" "$BRANCH_NAME" >/dev/null 2>&1 \
        || heresy "Failed to consecrate worktree. The branch '${BRANCH_NAME}' may already exist elsewhere."
    blessed "Worktree sanctified at ${WORKTREE_PATH}"
fi

if [[ -f "${REPO}/.env" && ! -e "${WORKTREE_PATH}/.env" ]]; then
    ln -s "${REPO}/.env" "${WORKTREE_PATH}/.env"
    litany ".env linked."
fi

PLAN_FILE="${WORKTREE_PATH}/RITE_OF_IMPLEMENTATION.md"

# ── Rite III: Inscribing the Rite of Implementation ────────────────────────────
rite "III — Inscribing the Rite of Implementation"

if [[ -f "$PLAN_FILE" ]]; then
    warning "A Rite of Implementation already exists — prior cognitation preserved."
else
    litany "Channeling the Omnissiah's wisdom through the Planning Cogitator..."
    litany "(This rite may require several moments of contemplation.)"
    echo ""

    CONTEXT_BLOCK=""
    if [[ -n "$PROJECT_NAME" ]]; then
        CONTEXT_BLOCK+="**Project:** ${PROJECT_NAME}\n"
        [[ -n "$PROJECT_DESC" ]] && CONTEXT_BLOCK+="**Project description:** ${PROJECT_DESC}\n\n"
    fi
    if [[ -n "$PARENT_TITLE" ]]; then
        CONTEXT_BLOCK+="**Parent issue:** ${PARENT_TITLE}\n"
        [[ -n "$PARENT_DESC" ]] && CONTEXT_BLOCK+="**Parent description:** ${PARENT_DESC}\n\n"
    fi

    PLAN_PROMPT="You are a senior engineer working in this codebase (a Django + React educational technology platform).

Your task is to produce an implementation plan for the following Linear issue, then write it to a file called \`RITE_OF_IMPLEMENTATION.md\` in the current directory.

---
**Issue:** ${ISSUE_ID} — ${ISSUE_TITLE}

${CONTEXT_BLOCK}**Description:**
${ISSUE_DESC}
---

Before writing the plan, explore the relevant areas of the codebase to understand the existing patterns and context.

The plan file must contain these sections:
1. **Overview** — What needs to be done and why (2-4 sentences)
2. **Codebase Areas** — Relevant files, modules, apps, or components
3. **Implementation Steps** — Ordered, specific steps with enough detail to act on
4. **Testing Approach** — How to verify the implementation is correct
5. **Open Questions / Risks** — Anything needing clarification before work begins

Write only the plan. The engineer will review it before implementation starts."

    cd "$WORKTREE_PATH"
    if [[ "$NO_CLAUDE" == true ]]; then
        warning "Planning Cogitator silenced."
    else
        claude -p "$PLAN_PROMPT" \
            --allowedTools "Read,Write,Glob,Grep,LS" \
            --permission-mode bypassPermissions \
            --no-session-persistence \
            >/dev/null 2>&1 || true
    fi

    if [[ ! -f "$PLAN_FILE" ]]; then
        warning "Planning Cogitator did not inscribe the file. Creating placeholder litany."
        cat > "$PLAN_FILE" << PLACEHOLDER
# Rite of Implementation: ${ISSUE_ID}

## ${ISSUE_TITLE}

> *The Planning Cogitator was unable to inscribe a full rite. Consult the issue and update this document before beginning implementation.*

## Overview

${ISSUE_DESC}

## Codebase Areas

- [ ] TBD

## Implementation Steps

- [ ] Step 1
- [ ] Step 2
- [ ] Step 3

## Testing Approach

TBD

## Open Questions / Risks

TBD
PLACEHOLDER
    fi

    blessed "Rite of Implementation inscribed."
fi

# ── Yield to Claude ─────────────────────────────────────────────────────────────
CLAUDE_SYSTEM="You are working on ${ISSUE_ID}: ${ISSUE_TITLE}.

A Rite of Implementation has been prepared at RITE_OF_IMPLEMENTATION.md in the current worktree. The engineer will review it before implementation begins.

Worktree: ${WORKTREE_PATH}
Branch: ${BRANCH_NAME}"

echo ""
echo -e "${GREEN}${BOLD}  ╔══════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}${BOLD}  ║   THE OMNISSIAH GUIDES YOUR MECHADENDRITES               ║${NC}"
echo -e "${GREEN}${BOLD}  ║   The rites are prepared.                                ║${NC}"
echo -e "${GREEN}${BOLD}  ║   Review the plan. Then let implementation commence.     ║${NC}"
echo -e "${GREEN}${BOLD}  ╚══════════════════════════════════════════════════════════╝${NC}"
echo ""

cd "$WORKTREE_PATH"
if [[ "$NO_CLAUDE" == true ]]; then
    blessed "Dry run complete. Worktree and plan ready at ${WORKTREE_PATH}"
else
    exec claude --append-system-prompt "$(printf '%s' "$CLAUDE_SYSTEM")"
fi
